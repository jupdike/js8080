<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Space Invaders</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#122B53">
  <meta name="theme-color" content="#122B53">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
  <style type="text/css">
    :-webkit-full-screen #screen {  
      width: 100%;
      height: 100%;
    }  

  body {
    margin: 0;
    padding: 0;
    background-color: #122B53;
    touch-action: manipulation;
    user-select: none;
    -webkit-touch-callout: none;     /* prevent callout to copy image, etc when tap to hold */
    -webkit-text-size-adjust: none;  /* prevent webkit from resizing text to fit */
    -webkit-user-select: none;       /* prevent copy paste, to allow, change 'none' to 'text' */}
  }

  canvas.fullscreen{
    display:block;

    position:absolute;
    top:0;
    left:0;
    
    width:100%;
    height:100%;
  }

  canvas#screen {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 100vmin;
    height: 114vmin;
  }

  /* works, but we don't need it */
  body, html {
    position: fixed;
  }

 </style>
 <script type="text/javascript" src="jquery.js"></script>
 <script type="text/javascript" src="js8080.js"></script>
 <script type="text/javascript" src="invaderse.js"></script>
 <script type="text/javascript" src="invadersf.js"></script>
 <script type="text/javascript" src="invadersg.js"></script>
 <script type="text/javascript" src="invadersh.js"></script>
 <script type="text/javascript" src="lrescue1.js"></script>
 <script type="text/javascript" src="lrescue2.js"></script>
 <script type="text/javascript" src="lrescue3.js"></script>
 <script type="text/javascript" src="lrescue4.js"></script>
 <script type="text/javascript" src="lrescue5.js"></script>
 <script type="text/javascript" src="lrescue6.js"></script>
 <script type="text/javascript" src="tn01.js"></script>
 <script type="text/javascript" src="tn02.js"></script>
 <script type="text/javascript" src="tn03.js"></script>
 <script type="text/javascript" src="tn04.js"></script>
 <script type="text/javascript" src="tn05.js"></script>
 <script type="text/javascript" src="controls.js"></script>
 <script type="text/javascript">
var audio = {};
function enableAudio() {
  audio.basehit = document.createElement('audio');
  audio.shot = document.createElement('audio');
  audio.ufohit = document.createElement('audio');
  audio.invhit = document.createElement('audio');
  audio.ufo = document.createElement('audio');
  audio.walk1 = document.createElement('audio');
  audio.walk2 = document.createElement('audio');
  audio.walk3 = document.createElement('audio');
  audio.walk4 = document.createElement('audio');
  audio.basehit.src='sound/basehit.mp3';
  audio.shot.src='sound/shot.mp3';
  audio.ufohit.src='sound/ufohit.mp3';
  audio.invhit.src='sound/invhit.mp3';
  audio.ufo.src='sound/ufo.mp3';
  audio.walk1.src='sound/walk1.mp3';
  audio.walk2.src='sound/walk2.mp3';
  audio.walk3.src='sound/walk3.mp3';
  audio.walk4.src='sound/walk4.mp3';
}

function createImageData(w, h) {
  if (!cpu.ctx || !cpu.ctx.createImageData) {
    cpu.ctx = null;
    $('#screen').replaceWith("<p style='width: 400px'><b>The graphical display of the emulators screen has been disabled. Your browser does not support the features of the HTML5 canvas element that are required. You need a browser that has the createImageData method on the canvas 2D rendering context object. Nightly builds of <a href='http://www.mozilla.org/developer/#builds'>Firefox 3.1</a> and <a href='http://nightly.webkit.org/'>WebKit</a> are known to work.</b></p>");
    return null;
  }
  else {
    return cpu.ctx.createImageData(w, h);
  }
}

function si() { 
  if (cpu.interval)
    clearInterval(cpu.interval);

  cpu = new Cpu(memoryUpdated, sound, interrupt);   
  cpu.count = 0;
  if($('#screen').length > 0) {
    cpu.ctx = $('#screen')[0].getContext('2d');
    cpu.video = createImageData(224*2, 256*2);
  }
  cpu.load(0x0000, invadersh);
  cpu.load(0x0800, invadersg);
  cpu.load(0x1000, invadersf);
  cpu.load(0x1800, invaderse);
  update(cpu);
}

function bb() { 
  if (cpu.interval)
    clearInterval(cpu.interval);

  cpu = new Cpu(memoryUpdated, sound, interrupt);   
  cpu.count = 0;
  if($('#screen').length > 0) {
    cpu.ctx = $('#screen')[0].getContext('2d');
    cpu.video = createImageData(224*2, 256*2);
  }
  cpu.load(0x0000, tn01);
  cpu.load(0x0800, tn02);
  cpu.load(0x1000, tn03);
  cpu.load(0x1800, tn04);
  cpu.load(0x4000, tn05);
  update(cpu);
}

function lr() { 
  if (cpu.interval)
    clearInterval(cpu.interval);

  cpu = new Cpu(memoryUpdated, sound, interrupt);   
  cpu.count = 0;
  if($('#screen').length > 0) {
    cpu.ctx = $('#screen')[0].getContext('2d');
    cpu.video = createImageData(224*2, 256*2);
  }
  cpu.load(0x0000, lrescue1);
  cpu.load(0x0800, lrescue2);
  cpu.load(0x1000, lrescue3);
  cpu.load(0x1800, lrescue4);
  cpu.load(0x4000, lrescue5);
  cpu.load(0x4800, lrescue6);
  update(cpu);
}

function flags(cpu) {
  return (cpu.f & ZERO ? "z" : ".") +
        (cpu.f & SIGN ? "s" : ".") +
        (cpu.f & PARITY ? "p" : ".") +
        (cpu.f & INTERRUPT ? "i" : ".") +
        (cpu.f & CARRY ? "c" : ".");
}   
function hex(n) {
  return pad(n.toString(16), 4);
}
function update(cpu) {
  $('#af').html(hex(cpu.af()));
  $('#bc').html(hex(cpu.bc()));
  $('#de').html(hex(cpu.de()));
  $('#hl').html(hex(cpu.hl()));
  $('#pc').html(hex(cpu.pc));
  $('#sp').html(hex(cpu.sp));
  $('#flags').html(flags(cpu));
  $('#cycles').html(cpu.cycles);
  $('#disassemble').html(cpu.disassemble(cpu.pc));
  if (cpu.ctx)
    cpu.ctx.putImageData(cpu.video, 0, 0);
}
function run1()
{
  cpu.step();
  update(cpu);
}
function runn()
{
  var n = parseInt($('#n')[0].value);
  var start = new Date();
  for(var i=0; i<n; ++i) {
    cpu.step();
  }
  var end = new Date();
  update(cpu);
  $('#time').html((end-start) + "ms");
}

function stopAnimate() {
  if (cpu.interval)
    clearInterval(cpu.interval);
  delete cpu.interval;
  update(cpu);
}
// cannot call this animate because it conflicts with the animate method on windows.animate
function anim() {
  if (cpu.interval)
    clearInterval(cpu.interval);
  cpu.interval = setInterval(function() {
    for(var i=0; i < (cpu.animate || 3000) ; ++i) {
      cpu.step();
    }
  }, 10);
}
function fullscreen() {
  var e = document.getElementById('screen');
  if (e.requestFullScreen) {  
    e.requestFullScreen();  
  } else if (e.mozRequestFullScreen) {  
    e.mozRequestFullScreen();  
  } else if (e.webkitRequestFullScreen) {  
    e.webkitRequestFullScreen();  
  }  
}
function mobile() {
  var e = document.getElementById('screen');
  e.className = "fullscreen";
}
function noper(event) {
  event.preventDefault();
}
</script>
</head>


<body oncontextmenu="noper(event)">
<!-- <button onclick='si();'>Space Invaders</button>
<button onclick='lr();'>Lunar Rescue</button>
<button onclick='bb();'>Balloon Bomber</button>
<a href="http://www.bluishcoder.co.nz/2008/09/javascript-space-invaders-emulator.html">About</a>
<br>
<button onclick='anim();'>Animate</button>
<button onclick='stopAnimate();'>Stop Animate</button>
<button onclick='run1();'>Run 1</button>
<button onclick='runn();'>Run n</button>
<input id="n" type="text" value="1000">
<button onclick='enableAudio()'>Enable Audio</button>
<button onclick='fullscreen()'>Fullscreen</button>
<button onclick='mobile()'>Mobile</button> -->
<p id="time"></p>
<table style="display: none; font-family: monospace">
<tr><th>af<th>bc<th>de<th>hl<th>pc<th>sp<th>flags<th>cycles
<tr><td><div id="af"><td><div id="bc"><td><div id="de"><td><div id="hl"><td><div id="pc"><td><div id="sp"><td><div id="flags"><td><div id="cycles">
</table>
<pre style="display: none" id="disassemble">
</pre>
<table style="display: none; float:right" border='1'>
<tr><th>key<th>action</tr>
<tr><td>z<td>left</tr>
<tr><td>x<td>right</tr>
<tr><td>.<td>fire</tr>
<tr><td>c<td>insert coin</tr>
<tr><td>1<td>1 player</tr>
</table>
<canvas 
style="background-color: black;"
id="screen" 
width="448" 
height="512">
</canvas>
<!-- <div id="controls" style="width: 74vmin; height: 12vmin; margin-left: auto; margin-right: auto;">
<center>
  <img id="btn-l" src="si-button.svg" style="width: 12vmin; height: 12vmin"/>
  <img id="btn-r" src="si-button.svg" style="width: 12vmin; height: 12vmin"/>
  <div style="display:inline;">
    <img src="si-button.svg" style="width: 6vmin; height: 4vmin; opacity: 0.01"/>
  </div>
  <img id="btn-c" src="si-button.svg" style="width: 6min; height: 6vmin"/>
  <img id="btn-1" src="si-button.svg" style="width: 6vmin; height: 6vmin"/>
  <div style="display:inline;">
    <img src="si-button.svg" style="width: 6vmin; height: 4vmin; opacity: 0.01"/>
  </div>
  <img id="btn-f" src="si-button.svg" style="width: 12vmin; height: 12vmin"/>
</center>
</div> -->

<div id="controls" style="display: block; width: 100vmin; height: 62.5vmin; margin-left: auto; margin-right: auto;">
  <div id="control-below-left" style="display: inline-block; background-image: url('majesty-controls-left.png'); background-size: contain; width: 50vmin; height: 62.5vmin; margin: 0; padding: 0"></div><!--no whitespace --><div id="control-below-right" style="display: inline-block; background-image: url('majesty-controls-right.png'); background-size: contain; width: 50vmin; height: 62.5vmin; margin: 0; padding: 0"></div>
</div>

<p id="status" style="display: none"></p>
<script type="text/javascript">
function pixelSet(video, y, x, r, g, b) {
  const w = 224;
  const chan = 4;
  const stride_per_row = w * chan * 2;
  const stride_per_y = stride_per_row * 2;
  // draw 2x2 pixel blocks
  var index;
  index = y * stride_per_y + x*2*4;
  video[index+0] = r;
  video[index+1] = g;
  video[index+2] = b;
  video[index+3] = 255;
  index += stride_per_row;
  video[index+0] = r;
  video[index+1] = g;
  video[index+2] = b;
  video[index+3] = 255;
  index = y * stride_per_y + x*2*4;
  video[index+0+4] = r;
  video[index+1+4] = g;
  video[index+2+4] = b;
  video[index+3+4] = 180;
  index += stride_per_row;
  video[index+0+4] = r;
  video[index+1+4] = g;
  video[index+2+4] = b;
  video[index+3+4] = 180;
}
function plotData(video, x, y, value, bit) {
  if (y < 0 || y >= 256 || x < 0 || x >= 224)
  {
    return;
  }
  var bt = (value >> bit) & 1;
  y = y-bit;
  var r = 0;
  var g = 0;
  var b = 0;
  if (bt) {
    // fake cellophane colors for different games since graphics are just white on black
    if (y >= 184+8 && y <= 238 && x >= 0 && x <= 223)
      g = 255;
    else if (y >= 240 && y <= 247 && x >= 16 && x <= 133)
      g = 255;
    else if (y >= 33 && y <= 33+16) {
      r = 255;
      g = 0;
      b = 0;
    }
    else {
      g = 250;
      b = 250;
      r = 250;
    } 
  }
  pixelSet(video, y, x, r, g, b);
}
function memoryUpdated(addr, value)
{
  if (!this.video)
    return;

  if (addr >= 0x2400) {
    // Update video memory
    var base = addr - 0x2400;
    var y = ~(((base & 0x1f) * 8) & 0xFF) & 0xFF;
    var x = base >> 5;
    for(var i=0; i<8; ++i) {
      plotData(this.video.data, x, y, value, i);
    }
  }
}
function sound(id) {   
  switch(id) {
  case 2:       
    sounds.shot.play();
    $('#status').html("bang!");
    break;
  case 3:
    sounds.basehit.play();
    $('#status').html("boom!");
    break;
  case 4:
    sounds.invhit.play();
    $('#status').html("kaboom!");
    break;
  case 11:
    sounds.walk1.play();
//       $('#status').html("walk1");
    break;
  case 12:
    sounds.walk2.play();
//       $('#status').html("walk2");
    break;
  case 13:
    sounds.walk3.play();
//       $('#status').html("walk3");
    break;
  case 14:
    sounds.walk4.play();
//       $('#status').html("walk4");
    break;
  case 15:
    sounds.ufohit.play();
    $('#status').html("ufo blows up!");
    break;
  }
}
function interrupt(n) {
  if (n == 0x10 && this.ctx)
    this.ctx.putImageData(this.video, 0, 0);
}

var cpu = {};

function downControl_Coin() {
  cpu.port1 |= 1;
}
function downControl_Left() {
  cpu.port1 |= 0x20;
}
function downControl_Right() {
  cpu.port1 |= 0x40;
}
function downControl_1P() {
  cpu.port1 |= 4;
}
function downControl_2P() {
  cpu.port1 |= 8; // ?
}
function downControl_Fire() {
  cpu.port1 |= 0x10;
}

function upControl_Coin() {
  cpu.port1 &= 255-1;
}
function upControl_Left() {
  cpu.port1 &= 255-0x20;
}
function upControl_Right() {
  cpu.port1 &= 255-0x40;
}
function upControl_1P() {
  cpu.port1 &= 255-4;
}
function upControl_2P() {
  cpu.port1 &= 255-8; // ?
}
function upControl_Fire() {
  cpu.port1 &= 255-0x10;
}

si();
document.addEventListener("keydown", function(e) {
  var evt = e || window.event;
  if(evt.keyCode == 67 || // c
    evt.keyCode == 192 || // tilde or backtick `
    evt.keyCode == 81 // q
  ) {
    downControl_Coin();
  }
  if(evt.keyCode == 49 // 1
  ) {
    downControl_1P();
  }
  if(evt.keyCode == 50 // 2
  ) {
    downControl_2P();
  }
  if(evt.keyCode == 190 || // . (period)
    evt.keyCode == 32 || // space
    evt.keyCode == 13 || // enter
    evt.keyCode == 188 || // , (comma)
    evt.keyCode == 191 || // / (slash)
    evt.keyCode == 90 || // z
    evt.keyCode == 88 // x
  ) {
    downControl_Fire();
  }
  if(evt.keyCode == 37 || // left arrow
    evt.keyCode == 65 || // a
    evt.keyCode == 74 // j
  ) {
    downControl_Left();
  }
  if(evt.keyCode == 39 || // right arrow
    evt.keyCode == 68 || // d
    evt.keyCode == 76 // l
  ) {
    downControl_Right();
  }
  return false;
}, false);
document.addEventListener("keyup", function(e) {
  var evt = e || window.event;
  // if(evt.keyCode == 67)
  //   cpu.port1 &= 255-1;
  // if(evt.keyCode == 49)
  //   cpu.port1 &= 255-4;
  // if(evt.keyCode == 190)
  //   cpu.port1 &= 255-0x10;
  // if(evt.keyCode == 90)
  //   cpu.port1 &= 255-0x20;
  // if(evt.keyCode == 88)
  //   cpu.port1 &= 255-0x40;
  if(evt.keyCode == 67 || // c
    evt.keyCode == 192 || // tilde or backtick `
    evt.keyCode == 81 // q
  ) {
    upControl_Coin();
  }
  if(evt.keyCode == 49 // 1
  ) {
    upControl_1P();
  }
  if(evt.keyCode == 50 // 2
  ) {
    upControl_2P();
  }
  if(evt.keyCode == 190 || // . (period)
    evt.keyCode == 32 || // space
    evt.keyCode == 13 || // enter
    evt.keyCode == 188 || // , (comma)
    evt.keyCode == 191 || // / (slash)
    evt.keyCode == 90 || // z
    evt.keyCode == 88 // x
  ) {
    upControl_Fire();
  }
  if(evt.keyCode == 37 || // left arrow
    evt.keyCode == 65 || // a
    evt.keyCode == 74 // j
  ) {
    upControl_Left();
  }
  if(evt.keyCode == 39 || // right arrow
    evt.keyCode == 68 || // d
    evt.keyCode == 76 // l
  ) {
    upControl_Right();
  }
  return false;
}, false);

// from: http://stackoverflow.com/questions/442404/dynamically-retrieve-html-element-x-y-position-with-javascript
function getOffset( el ) {
    var _x = 0;
    var _y = 0;
    while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
        _x += el.offsetLeft - el.scrollLeft;
        _y += el.offsetTop - el.scrollTop;
        el = el.parentNode;
    }
    return { top: _y, left: _x };
}

document.getElementById('screen').addEventListener("mousedown", function(e) {
  var evt = e || window.event;
  var offset = getOffset (document.getElementById('screen'));
  var y = evt.clientY - offset.top;
  var x = evt.clientX - offset.left;
  if(y <= 100 && x <= 112)
    cpu.port1 |= 1; // coin
  if(y <= 100 && x > 112)
    cpu.port1 |= 4;

  if(y > 100 && x >= 74 && x <= 150)
    cpu.port1 |= 0x10;

  if(y > 100 && x < 74)
    cpu.port1 |= 0x20;

  if(y > 100 && x > 150)
    cpu.port1 |= 0x40;
  
  return false;
}, false);
document.getElementById('screen').addEventListener("mouseup", function(e) {
  var evt = e || window.event;
  var offset = getOffset (document.getElementById('screen'));
  var y = evt.clientY - offset.top;
  var x = evt.clientX - offset.left;
  if(y <= 100 && x <= 112)
    cpu.port1 &= 255-1; // coin
  if(y <= 100 && x > 112)
    cpu.port1 &= 255-4; // 1 player

  if(y > 100 && x >= 74 && x <= 150)
    cpu.port1 &= 255-0x10;
  if(y > 100 && x < 74)
    cpu.port1 &= 255-0x20;
  if(y > 100 && x > 150)
    cpu.port1 &= 255-0x40;
  return false;
}, false);

window.AudioContext = window.AudioContext || window.webkitAudioContext;

const acontext = new AudioContext();

class Sound {
    url = '';
    buffer = null;
    sources = [];

    constructor(url) {
        this.url = url;
    }

    load() {
        if (!this.url) return Promise.reject(new Error('Missing or invalid URL: ', this.url));

        if (this.buffer) return Promise.resolve(this.buffer);

        return new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();

            request.open('GET', this.url, true);
            request.responseType = 'arraybuffer';

            // Decode asynchronously:
            request.onload = () => {
                acontext.decodeAudioData(request.response, (buffer) => {
                    if (!buffer) {
                        console.log(`Sound decoding error: ${ this.url }`);

                        reject(new Error(`Sound decoding error: ${ this.url }`));

                        return;
                    }

                    this.buffer = buffer;

                    resolve(buffer);
                });
            };

            request.onerror = (err) => {
                console.log('Sound XMLHttpRequest error:', err);

                reject(err);
            };

            request.send();
        });
    }

    play(volume = 1, time = 0) {
        if (!this.buffer) return;

        acontext.resume();

        // Create a new sound source and assign it the loaded sound's buffer:
        const source = acontext.createBufferSource();
        source.buffer = this.buffer;

        // Keep track of all sources created, and stop tracking them once they finish playing:
        const insertedAt = this.sources.push(source) - 1;
        source.onended = () => {
            source.stop(0);

            this.sources.splice(insertedAt, 1);
        };

        // Create a gain node with the desired volume:
        const gainNode = acontext.createGain();
        gainNode.gain.value = volume;

        // Connect nodes:
        source.connect(gainNode).connect(acontext.destination);

        // Start playing at the desired time:
        source.start(time);
    }

    stop() {
        // Stop any sources still playing:
        this.sources.forEach((source) => {
            source.stop(0);
        });
        this.sources = [];
    }

}

anim();

// fix audio on Safari so mixing works (multiple sounds playing simultaneously)
// see
// https://stackoverflow.com/questions/25654558/html5-js-play-same-sound-multiple-times-at-the-same-time
let sounds = {};
function sounder() {
  'basehit invhit shot ufo ufohit walk1 walk2 walk3 walk4'
  .split(' ').forEach(sound => {
    sounds[sound] = new Sound(`./sound/${sound}.mp3`);
    sounds[sound].load();
  });
}
sounder();

 </script>
</body>
<script>
document.getElementsByTagName('body')[0].addEventListener("contextmenu", (event) => {
  console.log('prevented default?');
  event.preventDefault();
});

// function addTouchEventListeners(id, down, up) {
//   var el = document.getElementById(id);
//   el.addEventListener("touchstart", down);
//   el.addEventListener("touchend", up);
//   el.addEventListener("touchcancel", up);
// }
// addTouchEventListeners('btn-l', downControl_Left, upControl_Left);
// addTouchEventListeners('btn-r', downControl_Right, upControl_Right);
// addTouchEventListeners('btn-c', downControl_Coin, upControl_Coin);
// addTouchEventListeners('btn-1', downControl_1P, upControl_1P);
// addTouchEventListeners('btn-f', downControl_Fire, upControl_Fire);

let controlsLeft = new Controls('control-below-left');
controlsLeft.addControl('C', 0.20, 0.15, 0.2, downControl_Coin, upControl_Coin);
controlsLeft.addControl('L', 0.15, 0.50, 0.24, downControl_Left, upControl_Left);
controlsLeft.addControl('R', 0.85, 0.50, 0.24, downControl_Right, upControl_Right);

let controlsRight = new Controls('control-below-right');
controlsRight.addControl('1', 0.85, 0.1, 0.2, downControl_1P, upControl_1P);
controlsRight.addControl('F', 0.50, 0.5, 0.4, downControl_Fire, upControl_Fire);




</script>
</html>
